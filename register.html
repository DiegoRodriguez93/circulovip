<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
  <!-- Bootstrap core CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <!-- Material Design Bootstrap -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.9/css/mdb.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/login.css">
  <title>Login</title>

</head>

<body>
  <!-- Main navigation -->
  <header>

    <!-- Full Page Intro -->
    <div class="view" style="background-image: url('images/back.jpg'); background-repeat: no-repeat; background-size: cover; background-position: center center;">
      <!-- Mask & flexbox options-->
      <div class="mask rgba-gradient align-items-center">
        <!-- Content -->
        <div class="container">
          <!--Grid row-->
          <div class="row">
            <!--Grid column-->
            <div class="col-md-12 white-text text-center text-md-left mt-xl-5 mb-5 margin22 wow fadeInRight" data-wow-delay="0.3s">
              <!--Form-->
        
                <div class="card wow fadeInRight" data-wow-delay="0.3s">
                  <div class="card-body">
                    <!--Header-->
                    <div class="text-center">
                      <h4>
                        <i class="fas fa-user violet-text"></i> Registrarse:</h4>
                      <hr class="hr-gris">
                    </div>
                    <!--Body-->
                    
                    <div class="md-form">
                      <i class="fas fa-address-card prefix white-text violet active  iconitos"></i>
                      <label for="">Cédula</label>
                      <input type="text" maxlength="8" id="cedula" class="indigo-text form-control solo_numeros">
                        <div id="errorDiv">
                      </div>
                    </div>

                    <div class="md-form">
                      <i class="fas fa-envelope prefix white-text violet active  iconitos"></i>
                      <input type="email" id="email" class="indigo-text form-control">
                      <label for="">Email</label>
                    </div>

                    <div class="md-form">
                      <i class="fas fa-envelope prefix white-text violet active iconitos"></i>
                      <input type="email" id="email2" class="indigo-text form-control">
                      <label for="">Repetir email</label>
                    </div>

                    <div class="md-form">
                      <i class="fas fa-phone prefix white-text violet active iconitos"></i>
                      <input type="text" id="phone" class="indigo-text form-control solo_numeros">
                      <label for="">Teléfono</label>
                    </div>

                    <div class="md-form">
                      <i class="fas fa-lock prefix white-text violet active iconitos"></i>
                      <input type="password" id="password" autocomplete="new-password" class="indigo-text form-control">
                      <label for="">Contraseña</label>
                    </div>

                    <div class="md-form">
                      <i class="fas fa-lock prefix violet-text violet active iconitos"></i>
                      <input type="password" id="password2" autocomplete="new-password" class="indigo-text form-control">
                      <label for="">Repetir contraseña</label>
                    </div>

                    <div class="text-center mt-4">
                      <button onclick="registerUser()" class="btn btn-indigo">Registrarse</button>

                      <hr class="hr-gris mb-3 mt-4">
                      <div class="inline-ul text-center">
                        <a href="index.html" class="indigo-text">
                          <i class="fas fa-sign-in-alt mr-3"></i>
                          Iniciar sesión</a><br><br>
                        <a class="p-2 m-2 tw-ic indigo-text" href="comercio/index.html">
                          <i class="fas fa-store indigo-text mr-3"></i>Comercios
                        </a>

                      </div>
                    </div>
                  </div>
                </div>
 
            </div>
            <!--Grid column-->

          </div>
          <!--Grid row-->
        </div>
        <!-- Content -->
      </div>
      <!-- Mask & flexbox options-->
    </div>
    <!-- Full Page Intro -->
  </header>
  <!-- Main navigation -->
  <!--Main Layout-->
    <!-- <main> -->
      <!-- <div class="container"> -->
        <!--Grid row-->
        <!-- <div class="row py-5"> -->
          <!--Grid column-->
          <!-- <div class="col-md-12 text-center"> -->
            <!-- <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
          </div> -->
          <!--Grid column-->
        <!-- </div> -->
        <!--Grid row-->
      <!-- </div> -->
    <!-- </main> -->
  <!--Main Layout-->

</body>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.9/js/mdb.min.js"></script>
<script src="lib/jquerysession.js"></script>
<script src="lib/helper.js"></script>
<script>
  // Animations init
  new WOW().init();

  $(document).ready(function(){

    $('#cedula').change(function(){

      $ced = $('#cedula').val();

      if(!comprobarCI($ced) || $ced == '' ){
        $( "<span id='smallError' class='ml-5 py-0 '></span>" ).appendTo( "#errorDiv" );
          $('#smallError').html('✘ Cedula inválida');
          $('#smallError').addClass('text-warning');
          return false;
        }

      $.ajax({
        type: "POST",
        url: "https://vida-apps.com/vidapesos/ajax/chequearUsuario.php",
        data: {usuario:$ced},
        dataType: "JSON",
        success: function (res) {
          if(res.result){
            $( "<span id='smallError' class='ml-5 py-0 '></span>" ).appendTo( "#errorDiv" );
            $('#smallError').html('✓ Cédula correcta');
            $('#smallError').addClass('text-success');
          }else{
            $( "<span id='smallError' class='ml-5 py-0 '></span>" ).appendTo( "#errorDiv" );
            $('#smallError').html('✘ La cedula no es socio de vida o no esta ingresada por un comercio');
          }
        }
      });

    });

  });

  async function registerUser() {

    
        $cedula     = $('#cedula').val();
        $email      = $('#email').val();
        $email2     = $('#email2').val();
        $phone      = $('#phone').val();
        $password   = $('#password').val();
        $password2  = $('#password2').val();

        if(!comprobarCI($cedula)){
          alert('Cédula inválida!');
          return false;
        }

        if(!validateEmail($email)){
          alert('Email inválido!');
          return false;
        }

        if($email != $email2){
          alert('Los email no coinciden!');
          return false;
        }

        if($phone.length < 8){
          alert('Teléfono inválido!');
          return false
        }

        if($phone.length == 9){
          if(!validatePhone($phone)){
            return false;
          }
        }

        if($password.length < 6){
          alert('Contraseña inválida, seleccione una contraseña de más de 6 caracteres');
          return false;
        }

        if($password != $password2){
          alert('Las contraseñas no coinciden');
          return false;
        }

        $todoOk = false;

        await $.ajax({
          type: "POST",
          url: "https://vida-apps.com/vidapesos/ajax/chequearUsuario.php",
          data: {usuario:$cedula},
          dataType: "JSON",
          success: function (res) {
            if(res.result){
              $todoOk = true;
            }else{
              alert(res.message);
              return false;
            }
          }

        });

        if($todoOk){
          $.ajax({
        type: "POST",
        url: "https://vida-apps.com/vidapesos/ajax/register_user.php",
        data: {usuario:$cedula,email:$email,phone:$phone,pass:$password},
        dataType: "JSON",
        success: function(res) {
          if(res.result){
            alert(res.message);
            $.session.set('id_user', res.id_user);
            location.replace('socio/index.html');
          }else{
            alert(res.message);
          }

        }

        });

        }

    }


</script>
</body>

</html>