<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta http-equiv="Cache-Control" content="no-cache" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Circulo Vip</title>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/colreorder/1.5.2/css/colReorder.dataTables.min.css">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/mdb.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <link rel="stylesheet" href="css/loader.css">
  <link href="../css/estilosmenu.css" rel="stylesheet">
 
  <!-- Modal CAMBIAR PASSWORD START -->
<div class="modal fade" id="changePassword" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document" data-backdrop="static" data-keyboard="false">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Cambiar Contraseña</h5>
      </div>
      <div class="modal-body">
        <label for="pass1">Nueva contraseña</label>
        <input type="password" class="form-control" id="pass1">
        <label for="pass2">Repetir contraseña</label>
        <input type="password" class="form-control" id="pass2">
      </div>
      <div class="modal-footer"><div class="mx-auto">
        <button type="button" onclick="changePassword()" class="btn btn-indigo">Cambiar contraseña</button>
      </div>
      </div>
    </div>
  </div>
</div> 
<!-- Modal CAMBIAR PASSWORD END -->

<!-- MODAL CONFIRM TRANSACCIÓN-->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
  aria-hidden="true" data-backdrop="static" data-keyboard="false">

  <!-- Change class .modal-sm to change the size of the modal -->
  <div class="modal-dialog  modal-top" role="document">


    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title w-100" id="modalTitle"></h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="hidden_id_cupon">
        <h3>Datos del comercio:</h3>
        <h4 id="commerce_name"></h4>
        <h4 id="commerce_address"></h4>
        <h4 id="commerce_phone"></h4>
        <hr>
        <h4 id="fecha_vencimiento"></h4>
        <h4 id="descuento"></h4>
      </div>
      <div class="modal-footer text-center mx-auto">
        <button type="button" id="confirmarTransaccionBtn" class="btn btn-indigo">Confirmar</button>
        <button type="button" id="cancelarTransaccionBtn" class="btn btn-blue-grey" data-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>
<!-- MODAL CONFIRM TRANSACCIÓN-->

<!-- MODAL CONTACT-->
<div class="modal fade" id="contactModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
  aria-hidden="true" data-backdrop="static" data-keyboard="false">

  <!-- Change class .modal-sm to change the size of the modal -->
  <div class="modal-dialog  modal-top" role="document">


    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title w-100" id="contactModalTitle">Enviar mensaje</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">

        <input type="hidden" id="id_user_receptor" >

        <label for="mensajeContactModal">Mensaje</label>
        <textarea id="mensajeContactModal" maxlength="250" class="form-control"></textarea>
    

      <div class="modal-footer text-center mx-auto">
        <button type="button" id="enviarMensajeBtn" onclick="enviarMensaje()" class="btn btn-indigo">Enviar mensaje </button>
        <button type="button" class="btn btn-blue-grey" data-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>
</div>
<!-- MODAL CONTACT-->


<body class="grey lighten-3">
    <div style="display:none" class="loading"></div>
  <!--Main Navigation-->
  <header>

    <!-- Navbar -->

      <div class="container-fluid">

        <!-- Brand -->


        <div id="menuToggle" >

          <input type="checkbox">
          <span></span>
          <span></span>
          <span></span>
        </div>

      </div>
 
    <!-- Navbar -->

    <!-- SIDEBAR AQUI -->

<div id="sidebar_aqui"></div>


  </header>
  <!--Main Navigation-->

  <div style="background-image: url('../images/back1.jpg');position:fixed;height: 250px;width: 100%;display: none;"></div>
  <!--Main layout-->
  <main class="pt-3 mx-lg-5">
    <div class="container-fluid mt-5" style="min-height: 480px">

      
      
      <!--Grid row-->
      <div class="row wow fadeIn">

        <!--Grid column-->
        <div class="col-md-3 mb-4">

          <div class="card">

                <div class="card-body">
                  <div class="row">
                    <div class="col-8">                  <span style="font-size: 0.85em;">CITAS SOLICITADAS</span><BR>
                      <b><span id="citasSolicitadasBadge">0</span></b> </div>

                    <div class="col-4 text-white deep-purple-text">
                      <i class="fa fa-calendar-day fa-3x"></i>
                    </div>
                  </div>

                </div>

        </div>
        </div>
        <!--Grid column-->

        <!--Grid column-->
        <div class="col-md-3 mb-4">

          <div class="card">

                <div class="card-body">
                  <div class="row">
                    <div class="col-8">                  <span style="font-size: 0.85em;">CITAS CONFIRMADAS</span><BR>
                      <b><span id="citasConfirmadasBadge">0</span></b> </div>

                    <div class="col-4 text-white light-green-text">
                      <i class="fa fa-clipboard-check fa-3x"></i>
                    </div>
                  </div>

                </div>

        </div>
        </div>
        <!--Grid column-->

      <!--Grid column-->
      <div class="col-md-3 mb-4">

        <div class="card">

              <div class="card-body">
                <div class="row">
                  <div class="col-8">                  <span style="font-size: 0.85em;">CITAS RECHAZADAS</span><BR>
                    <b><span id="citasRechazadasBadge">0</span></b> </div>

                  <div class="col-4 text-white red-text">
                    <i class="fa fa-calendar-times fa-3x"></i>
                  </div>
                </div>

              </div>

      </div>
      </div>
      <!--Grid column-->

      <!--Grid column-->
      <div class="col-md-3 mb-4">

        <div class="card">

              <div class="card-body">
                <div class="row">
                  <div class="col-8">                  <span style="font-size: 0.85em;">MENSAJES</span><BR>
                    <b><span id="mensajesBadge">0</span></b> </div>

                  <div class="col-4 text-white indigo-text">
                    <i class="fa fa-envelope fa-3x"></i>
                  </div>
                </div>

              </div>

      </div>
      </div>
      <!--Grid column-->





      </div>
      <!--Grid row-->

      <!--Grid row-->
      <div class="row wow fadeIn">

        <!--Grid column-->
        <div class="col-md-6 sm-12 mb-4">

          <!--Card-->
          <div class="card">

              <h4 class="card-header text-center">
                     Citas
              </h4>
              <table id="tableCitas" class="table responsive text-center" style="width: 100%;">
                <thead>
                  <tr>
                    <th>Avatar</th>
                    <th>Nombre</th>
                    <th>Datos</th>
                    <th>Opciones</th>
                    <th>Estado</th>
                  </tr>
                </thead>
              </table>
          </div>
          <!--/.Card-->
          <div id="citasContainer"></div>
          <div class="mb-5"></div>
        </div>
        <!--Grid column-->

        
        <!--Grid column-->
        <div class="col-md-6 sm-12 mb-4">

          <!--Card-->
          <div class="card">

              <h5 class="card-header">
                  <b>Últimos mensajes</b> 
                  <table id="tableMensajes" class="table responsive text-center" style="width: 100%;">
                    <thead>
                      <tr>
                        <th> </th>
                        <th> </th>
                        <th> </th>
                        <th>Fecha</th>
                      </tr>
                    </thead>
                  </table>
              </h5>

          </div>
          <!--/.Card-->
          <div class="mb-5"></div>
        </div>
        <!--Grid column-->

      </div>
      <!--Grid row-->


    </div>
  </main>
  <!--Main layout-->

  <!--Footer-->
  <footer class="page-footer text-center font-small deep-purple darken-1 mt-4 wow fadeIn" style="
bottom: 0;position: fixed;width: 100%;
">

    <!--Copyright-->
    <div class="footer-copyright py-3">
      © 2020 Copyright
      <a href="https://circulovip.com" target="_blank"> Circulo Vip Empresarial </a>
    </div>
    <!--/.Copyright-->

  </footer>
  <!--/.Footer-->

  <div id="modal_aqui"></div>

  <!-- SCRIPTS -->
  <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
  <script type="text/javascript" src="js/popper.min.js"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <script type="text/javascript" src="js/mdb.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/colreorder/1.5.2/js/dataTables.colReorder.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
  <script src="../lib/helper.js"></script>
  <script src="include/sidebar.js"></script>
  <script src="js/cerrar_session.js"></script>

  <script>
function cancelarCita($id_cita){
      
      const swalWithBootstrapButtons = Swal.mixin({
  customClass: {
    confirmButton: 'btn btn-success',
    cancelButton: 'btn btn-danger'
  },
  buttonsStyling: false
})

swalWithBootstrapButtons.fire({
  title: '¿Estas seguro?',
  text: "Se va a rechazar la cita!",
  icon: 'warning',
  showCancelButton: true,
  confirmButtonText: 'Si, rechazar!',
  cancelButtonText: 'No, quiero rechazar!'
}).then((result) => {
  if (result.value) {

    $.ajax({
      type: "POST",
      url: "../ajax/socio/index/cancelarCita.php",
      data: {id_cita: $id_cita},
      dataType: "JSON",        
      beforeSend: function () {
          $('.loading').css('display','block');
        },
      success: function (res) {
        if(res.result){
          swalWithBootstrapButtons.fire(
          'Rechazado!',
          res.message,
          'success'
        )
         startTable2();

        }else{
          swalWithBootstrapButtons.fire(
            'Ha ocurrido un error',
            res.message,
            'error'
          )
        }
      },complete: function () {
          $('.loading').css('display','none');
        }
    });


  }else{
    swalWithBootstrapButtons.fire(
      'Cancelado',
      'Acción cancelada',
      'error'
    )
  }
})


    }

    function aceptarCita($id_cita){
      
      const swalWithBootstrapButtons = Swal.mixin({
  customClass: {
    confirmButton: 'btn btn-success',
    cancelButton: 'btn btn-danger'
  },
  buttonsStyling: false
})

swalWithBootstrapButtons.fire({
  title: '¿Estas seguro?',
  text: "Se va a aceptar la cita!",
  icon: 'warning',
  showCancelButton: true,
  confirmButtonText: 'Si, aceptar!',
  cancelButtonText: 'No, cancelar!'
}).then((result) => {
  if (result.value) {

    $.ajax({
      type: "POST",
      url: "../ajax/socio/index/aceptarCita.php",
      data: {id_cita: $id_cita},
      dataType: "JSON",        
      beforeSend: function () {
          $('.loading').css('display','block');
        },
      success: function (res) {
        if(res.result){
          swalWithBootstrapButtons.fire(
          'Aceptado!',
          res.message,
          'success'
        )
         startTable2();

        }else{
          swalWithBootstrapButtons.fire(
            'Ha ocurrido un error',
            res.message,
            'error'
          )
        }
      },complete: function () {
          $('.loading').css('display','none');
        }
    });


  }else{
    swalWithBootstrapButtons.fire(
      'Cancelado',
      'Acción cancelada',
      'error'
    )
  }
})


    }
    
    function enviarMensaje(){

$mensaje = $('#mensajeContactModal').val();
$id_user_receptor = $('#id_user_receptor').val();

$.ajax({
  type: "POST",
  url: "../ajax/socio/index/enviarMensaje.php",
  data: {id_user_emisor: localStorage.getItem('id_user'),
  id_user_receptor: $id_user_receptor,
  mensaje: $mensaje},
  dataType: "JSON",beforeSend: function(){
    $('#enviarMensajeBtn').addClass('disabled');
  },
  success: function (res) {
    if(res.result){
      $('#contactModal').modal('hide');
    $('#id_user_receptor').val('');
    $('#mensajeContactModal').val('');
    Swal.fire(
      'Correcto!',
      'Mensaje enviado correctamente!',
      'success'
    );
    }else{
      Swal.fire(
      'Error!',
      res.message,
      'error'
    );
    }

  },complete: function(){
    $('#enviarMensajeBtn').removeClass('disabled');
  }
});

}
    
    function abrirModalMensaje($id_user_receptor, $nombre){

$('#id_user_receptor').val($id_user_receptor);

$('#contactModalTitle').html('Enviar mensaje a '+$nombre);

$('#contactModal').modal('show');

}

    function listarCitas(){

      $id_user = localStorage.getItem('id_user');
      $zona_horaria = localStorage.getItem('zona_horaria');

      $.ajax({
        type: "POST",
        url: "../ajax/socio/index/listarCitas.php",
        data: {id_user:$id_user, zona_horaria:$zona_horaria},
        dataType: "JSON",
        success: function (data) {
          var html = '',
      el = document.getElementById("citasContainer");
      $.each(data, function (key, val) {

         html += `<div class="row">
              <div class="col-md-12 sm-12 my-1">
                <div class="card">
                <div class="row">

                  <div class="col-6 m-auto text-center">
                    <img 
                    src="`+val.avatar+`"
                     class="img-fluid p-3" 
                     style="max-height: 140px;"
                     alt="">
                  </div>
                  <div class="col-6 my-auto">
                    <b style="font-size: 1.3em;">`+val.nombre+`</b>
                    <p>`+val.tipo+`</p>
                    <p>`+val.estado+`</p>
                  </div>
                  <div class="col-12 text-center">
                    <button onclick="editarProductoModal('`+val.button+`')" class="btn btn-indigo btn-sm">Editar</button>
                    <button onclick="eliminarProducto('`+val.button+`')" class="btn btn-danger btn-sm">Eliminar</button>
                  </div>
                </div>
              </div></div></div>`;

      });

      el.innerHTML = html;
        }
      });



    }

function rellenarBadges(){

  $id_user = localStorage.getItem('id_user');

  $.ajax({
    type: "POST",
    url: "../ajax/socio/index/rellenarBadges.php",
    data: {id_user:$id_user},
    dataType: "JSON",
    success: function (res) {
      $('#citasSolicitadasBadge').html(res.citas_solicitadas);
      $('#citasConfirmadasBadge').html(res.citas_confirmadas);
      $('#citasRechazadasBadge').html(res.citas_rechazadas);
      $('#mensajesBadge').html(res.mensajes);
    }
  });

}

function startTable(){

if ( ! $.fn.DataTable.isDataTable( '#tableMensajes' ) ) {
  $id_user = localStorage.getItem('id_user');
          //cargamos la tabla
           table = $('#tableMensajes').DataTable({
              ajax : '../ajax/socio/mensajes/listar_mensajes_socio.php?id_receptor='+$id_user+'?limit=5',
              lengthChange: false,
              "info": false,
              "searching": false,
              "ordering": false,
              "paging": false,
              oLanguage: {
              "sUrl": "../json/traducciontabla_mensajes.json"
              }});
}else{
  //ajax reload

  table.ajax.reload();
 
} }

function startTable2(){

if ( ! $.fn.DataTable.isDataTable( '#tableCitas' ) ) {

  $id_user = localStorage.getItem('id_user');
  $zona_horaria = localStorage.getItem('zona_horaria');

          //cargamos la tabla
           table = $('#tableCitas').DataTable({
              ajax : '../ajax/socio/index/listarCitas.php?id_user='+$id_user+'&zona_horaria='+$zona_horaria,
              lengthChange: false,
              "info": false,
              "searching": false,
              "ordering": false,
              "paging": false,
              oLanguage: {
              "sUrl": "../json/traducciontabla_mensajes.json"
              }});
}else{
  //ajax reload

  table.ajax.reload();
 
} }

  $(document).ready(function(){ 

/* INCLUDES */

$('#sidebar_aqui').html(sidebar);

/* NAVBUTTON */

$('#menuToggle').on('click',function(){

$( "#sidebar" ).toggle("normal"); 


});

  startTable();
  startTable2();
   rellenarBadges();
/*    listarCitas(); */

  // Animations initialization
  new WOW().init();

/*    listarEmpresa();  */
/* 

    if($nombre != null && $nombre.length > 1 && $id_user != null && $id_user.length > 0 &&
  $token != null && $token.length == 32){
    location.replace('../index.html');
  }else{
    console.log('usuario no logeado');
  }  */


  });
  
  
  </script>

</body>

</html>